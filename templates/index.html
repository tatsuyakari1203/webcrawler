<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Doc Crawler</title>
  <!-- Bootstrap CSS CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <!-- Feather Icons CDN -->
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Google Font: Inter -->
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
  <style>
    :root {
      --bg-dark: #0d1117;
      --card-dark: #161b22;
      --input-dark: #21262d;
      --accent: #58a6ff;
      --error: #f97583;
      --success: #4ade80;
      --text-muted: #8b949e;
      --border-dark: #30363d;
      --hover-dark: #1c2526;
    }
    body {
      background-color: var(--bg-dark);
      color: #e6edf3;
      font-family: 'Inter', sans-serif;
    }
    .bg-card-dark {
      background-color: var(--card-dark);
      border: 1px solid var(--border-dark);
    }
    .form-control, .form-control:focus {
      background-color: var(--input-dark);
      border-color: var(--border-dark);
      color: #e6edf3;
    }
    .form-control:focus {
      box-shadow: 0 0 0 0.2rem rgba(88, 166, 255, 0.25);
    }
    .form-control[readonly] {
      background-color: #2a323c;
      opacity: 0.8;
    }
    .btn-accent {
      background-color: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    .btn-accent:hover {
      background-color: rgba(88, 166, 255, 0.8);
      border-color: rgba(88, 166, 255, 0.8);
    }
    .btn-success {
      background-color: var(--success);
      border-color: var(--success);
      color: #1a2e05;
    }
    .btn-success:hover {
      background-color: rgba(74, 222, 128, 0.8);
      border-color: rgba(74, 222, 128, 0.8);
    }
    .btn-error {
      background-color: var(--error);
      border-color: var(--error);
      color: white;
    }
    .btn-error:hover {
      background-color: rgba(249, 117, 131, 0.8);
      border-color: rgba(249, 117, 131, 0.8);
    }
    .text-muted-custom {
      color: var(--text-muted);
    }
    .title-white {
      color: #ffffff;
    }
    .title-white i {
      color: #ffffff;
    }
    .card {
      color: #ffffff;
    }
    .card i {
      color: #ffffff;
    }
    .custom-scroll::-webkit-scrollbar {
      width: 6px;
    }
    .custom-scroll::-webkit-scrollbar-track {
      background: var(--card-dark);
      border-radius: 3px;
    }
    .custom-scroll::-webkit-scrollbar-thumb {
      background: var(--border-dark);
      border-radius: 3px;
    }
    .custom-scroll::-webkit-scrollbar-thumb:hover {
      background: var(--accent);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
      animation: fadeIn 0.4s ease-out forwards;
    }
    .progress-bar {
      background-color: var(--accent);
      transition: width 0.5s ease-in-out;
    }
    .toast {
      max-width: 300px;
      border: none;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    .toast-success {
      background-color: rgba(74, 222, 128, 0.95);
      color: #1a2e05;
    }
    .toast-error {
      background-color: rgba(249, 117, 131, 0.95);
      color: white;
    }
    .toast-info {
      background-color: rgba(88, 166, 255, 0.95);
      color: white;
    }
    .toast-body {
      word-wrap: break-word;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }
    .tooltip-custom {
      position: relative;
    }
    .tooltip-custom:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background-color: #21262d;
      color: #e6edf3;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      white-space: nowrap;
      z-index: 10;
    }
    @media (max-width: 768px) {
      .container-xl {
        padding-left: 15px;
        padding-right: 15px;
      }
      .row.g-4 {
        gap: 1rem;
      }
      .card {
        padding: 1rem;
      }
      .form-control {
        font-size: 0.9rem;
      }
      .btn {
        font-size: 0.9rem;
        padding: 0.5rem 1rem;
      }
      .system-status-row {
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      .system-status-row span {
        font-size: 0.85rem;
      }
      canvas {
        max-height: 200px;
      }
    }
    @media (max-width: 576px) {
      .form-row-small {
        flex-direction: column;
      }
      .system-status-row {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body class="min-vh-100 d-flex flex-column">
  <!-- Header -->
  <header class="bg-card-dark py-3 px-4 shadow-lg border-bottom border-dark">
    <div class="container-xl d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-3">
        <i data-feather="search" class="text-accent" style="width: 24px; height: 24px;"></i>
        <h1 class="h4 mb-0 fw-semibold">Web Crawler</h1>
      </div>
      <div class="d-flex align-items-center gap-3">
        <span class="small text-muted-custom">v1.0.0</span>
        <span class="small text-muted-custom">by tatsuyakari</span>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-grow-1 container-xl px-4 py-5">
    <div class="row g-4">
      <section class="col-12">
        <!-- Crawl Configuration -->
        <div class="card bg-card-dark shadow-sm rounded-3 p-4 mb-4">
          <h2 class="h5 fw-semibold mb-4 title-white">Crawl Configuration</h2>
          <form id="crawl-form" class="row g-3">
            <div class="col-12">
              <label for="url" class="form-label small text-muted-custom fw-medium">Root URL</label>
              <input type="url" id="url" class="form-control rounded-2" placeholder="https://example.com/docs" required>
              <small class="form-text text-muted-custom">Enter the base URL to start crawling (includes subpages).</small>
            </div>
            <div class="d-flex flex-wrap form-row-small gap-3">
              <div class="col-md-3 col-lg-2 tooltip-custom flex-grow-1" data-tooltip="Maximum tokens to process">
                <label for="max_tokens" class="form-label small text-muted-custom fw-medium">Max Tokens</label>
                <input type="number" id="max_tokens" class="form-control rounded-2" value="2000000" min="1000">
              </div>
              <div class="col-md-3 col-lg-2 tooltip-custom flex-grow-1" data-tooltip="Depth of subpage crawling">
                <label for="max_depth" class="form-label small text-muted-custom fw-medium">Max Depth</label>
                <input type="number" id="max_depth" class="form-control rounded-2" value="2" min="1">
              </div>
              <div class="col-md-3 col-lg-2 tooltip-custom flex-grow-1" data-tooltip="Server-adjusted concurrent requests">
                <label for="concurrency" class="form-label small text-muted-custom fw-medium">Concurrency</label>
                <input type="number" id="concurrency" class="form-control rounded-2" value="3" min="1" max="10" readonly>
              </div>
              <div class="col-md-3 col-lg-2 tooltip-custom flex-grow-1" data-tooltip="Request timeout in seconds">
                <label for="timeout" class="form-label small text-muted-custom fw-medium">Timeout (s)</label>
                <input type="number" id="timeout" class="form-control rounded-2" value="10" min="5">
              </div>
              <div class="col-md-6 col-lg-2 tooltip-custom flex-grow-1" data-tooltip="Maximum pages to crawl">
                <label for="max_pages" class="form-label small text-muted-custom fw-medium">Max Pages</label>
                <input type="number" id="max_pages" class="form-control rounded-2" value="100" min="1">
              </div>
            </div>
            <div class="col-12 d-flex gap-3 flex-wrap">
              <button type="submit" id="crawl-btn" class="btn btn-accent px-4 py-2 d-flex align-items-center">
                <span id="btn-text">Start Crawl</span>
                <i data-feather="loader" id="btn-spinner" class="ms-2" style="width: 16px; height: 16px; display: none;"></i>
              </button>
              <button type="button" id="cancel-btn" class="btn btn-error px-4 py-2 d-flex align-items-center d-none">
                <i data-feather="x" class="me-2" style="width: 16px; height: 16px;"></i>Cancel
              </button>
            </div>
          </form>
          <div class="mt-4">
            <a id="download" href="/download" class="btn btn-success px-4 py-2 d-flex align-items-center d-none">
              <i data-feather="download" class="me-2" style="width: 16px; height: 16px;"></i>Download JSON
            </a>
            <p id="download-wait" class="small text-muted-custom mt-2 d-none">Processing crawl data... For LLM use, preprocess to inline content.</p>
          </div>
        </div>

        <!-- System Status -->
        <div class="card bg-card-dark shadow-sm rounded-3 p-4 mb-4">
          <h3 class="small fw-medium mb-3 title-white">System Status</h3>
          <div class="system-status-row d-flex gap-4 align-items-center mb-3">
            <span id="cpu-status"><i data-feather="cpu" class="text-accent me-2" style="width: 16px; height: 16px;"></i>CPU: --%</span>
            <span id="ram-status"><i data-feather="database" class="text-accent me-2" style="width: 16px; height: 16px;"></i>RAM: --%</span>
            <span id="temp-status"><i data-feather="thermometer" class="text-accent me-2" style="width: 16px; height: 16px;"></i>Temp: --°C</span>
            <span id="busy-status"><i data-feather="activity" class="text-accent me-2" style="width: 16px; height: 16px;"></i>Status: Idle</span>
            <span id="pages-crawled"><i data-feather="file-text" class="text-accent me-2" style="width: 16px; height: 16px;"></i>Pages: 0</span>
            <span id="total-tokens"><i data-feather="hash" class="text-accent me-2" style="width: 16px; height: 16px;"></i>Tokens: 0</span>
            <span id="queue-size"><i data-feather="list" class="text-accent me-2" style="width: 16px; height: 16px;"></i>Queue: 0</span>
          </div>
          <canvas id="systemChart" style="max-height: 250px;"></canvas>
        </div>

        <!-- Activity Log -->
        <div class="card bg-card-dark shadow-sm rounded-3 p-4">
          <h3 class="small fw-medium text-muted-custom mb-3">Activity Log</h3>
          <div id="log" class="bg-input-dark p-3 rounded-2 border border-dark text-xs font-monospace custom-scroll" style="height: 16rem; overflow-y: auto;"></div>
          <div class="mt-3">
            <div class="progress rounded-pill" style="height: 8px;">
              <div id="progress-bar" class="progress-bar rounded-pill" style="width: 0%;"></div>
            </div>
            <p id="progress-text" class="small text-muted-custom mt-2">0% - 0 pages crawled</p>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Toast Container -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1050;"></div>

  <!-- Footer -->
  <footer class="bg-card-dark py-3 text-center text-muted-custom border-top border-dark">
    <small>Built by <a href="https://github.com/tatsuyakari1203" class="text-accent text-decoration-none">tatsuyakari</a> · 2025</small>
  </footer>

  <!-- Bootstrap JS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <!-- JavaScript -->
  <script>
    feather.replace();

    const form = document.getElementById('crawl-form');
    const logEl = document.getElementById('log');
    const crawlBtn = document.getElementById('crawl-btn');
    const btnText = document.getElementById('btn-text');
    const btnSpinner = document.getElementById('btn-spinner');
    const cancelBtn = document.getElementById('cancel-btn');
    const downloadBtn = document.getElementById('download');
    const downloadWait = document.getElementById('download-wait');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const cpuStatus = document.getElementById('cpu-status');
    const ramStatus = document.getElementById('ram-status');
    const tempStatus = document.getElementById('temp-status');
    const busyStatus = document.getElementById('busy-status');
    const pagesCrawledEl = document.getElementById('pages-crawled');
    const totalTokensEl = document.getElementById('total-tokens');
    const queueSizeEl = document.getElementById('queue-size');
    const concurrencyInput = document.getElementById('concurrency');
    const toastContainer = document.querySelector('.toast-container');

    let eventSource;
    let pagesCrawled = 0;
    let currentQueue = 0;
    let maxPages = 100;

    // Chart initialization
    const ctx = document.getElementById('systemChart').getContext('2d');
    const systemChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          { label: 'CPU (%)', data: [], borderColor: '#58a6ff', tension: 0.1, fill: false },
          { label: 'RAM (%)', data: [], borderColor: '#4ade80', tension: 0.1, fill: false },
          { label: 'Temp (°C)', data: [], borderColor: '#f97583', tension: 0.1, fill: false }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { display: false },
          y: { beginAtZero: true, max: 100 }
        },
        plugins: {
          legend: { labels: { color: '#ffffff' } }
        }
      }
    });

    // Show toast popup
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast align-items-center border-0 fade-in ${
        type === 'error' ? 'toast-error' : type === 'success' ? 'toast-success' : 'toast-info'
      }`;
      toast.role = 'alert';
      toast.ariaLive = 'assertive';
      toast.ariaAtomic = 'true';
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      `;
      toastContainer.appendChild(toast);
      const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
      bsToast.show();
      toast.addEventListener('hidden.bs.toast', () => toast.remove());
    }

    // Add log entry and conditionally show toast
    function addLog(message, type = 'info') {
      const entry = document.createElement('div');
      let color = type === 'error' ? 'text-danger' : type === 'success' ? 'text-success' : 'text-light';
      entry.className = `d-flex align-items-center ${color} mb-1 fade-in`;
      entry.innerHTML = `<i data-feather="chevron-right" class="me-2" style="width: 12px; height: 12px;"></i>${message}`;
      logEl.appendChild(entry);
      feather.replace();
      logEl.scrollTop = logEl.scrollHeight;

      if (message.includes('Crawl started') || 
          message.includes('Crawl finished') || 
          message.includes('Error') || 
          message.includes('Cancelled') || 
          message.includes('Server is busy') || 
          message.includes('completed')) {
        showToast(message, type);
      }
    }

    // Update system status and chart
    async function updateStatus() {
      try {
        const res = await fetch('/detailed-status');
        if (!res.ok) throw new Error('Status fetch failed');
        const data = await res.json();
        cpuStatus.innerHTML = `<i data-feather="cpu" class="text-accent me-2" style="width: 16px; height: 16px;"></i>CPU: ${data.server.cpu}%`;
        ramStatus.innerHTML = `<i data-feather="database" class="text-accent me-2" style="width: 16px; height: 16px;"></i>RAM: ${data.server.ram}%`;
        tempStatus.innerHTML = `<i data-feather="thermometer" class="text-accent me-2" style="width: 16px; height: 16px;"></i>Temp: ${data.server.temperature}°C`;
        busyStatus.innerHTML = `<i data-feather="activity" class="text-accent me-2" style="width: 16px; height: 16px;"></i>Status: ${data.crawler.is_busy ? 'Busy' : 'Idle'}`;
        pagesCrawledEl.innerHTML = `<i data-feather="file-text" class="text-accent me-2" style="width: 16px; height: 16px;"></i>Pages: ${data.crawler.pages_crawled || 0}`;
        totalTokensEl.innerHTML = `<i data-feather="hash" class="text-accent me-2" style="width: 16px; height: 16px;"></i>Tokens: ${data.crawler.total_tokens || 0}`;
        queueSizeEl.innerHTML = `<i data-feather="list" class="text-accent me-2" style="width: 16px; height: 16px;"></i>Queue: ${data.crawler.queue_size || 0}`;
        currentQueue = data.crawler.queue_size || 0;
        concurrencyInput.value = data.crawler.is_busy ? data.crawler.concurrency || 3 : 3;
        feather.replace();

        // Update chart
        const now = new Date().toLocaleTimeString();
        systemChart.data.labels.push(now);
        systemChart.data.datasets[0].data.push(data.server.cpu);
        systemChart.data.datasets[1].data.push(data.server.ram);
        systemChart.data.datasets[2].data.push(data.server.temperature === 'N/A' ? 0 : data.server.temperature);
        if (systemChart.data.labels.length > 20) {
          systemChart.data.labels.shift();
          systemChart.data.datasets.forEach(dataset => dataset.data.shift());
        }
        systemChart.update();
      } catch (error) {
        console.error('Status update error:', error);
      }
      setTimeout(updateStatus, 1000);
    }
    updateStatus();

    // Form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      crawlBtn.disabled = true;
      btnText.textContent = 'Crawling...';
      btnSpinner.style.display = 'inline-block';
      cancelBtn.classList.remove('d-none');
      downloadBtn.classList.add('d-none');
      downloadWait.classList.add('d-none');
      progressBar.style.width = '0%';
      progressText.textContent = '0% - 0 pages crawled';
      pagesCrawled = 0;
      currentQueue = 0;
      maxPages = parseInt(document.getElementById('max_pages').value) || 100;
      logEl.innerHTML = '';

      const formData = {
        url: document.getElementById('url').value,
        max_tokens: document.getElementById('max_tokens').value,
        max_depth: document.getElementById('max_depth').value,
        concurrency: document.getElementById('concurrency').value,
        timeout: document.getElementById('timeout').value,
        max_pages: document.getElementById('max_pages').value
      };

      eventSource = new EventSource('/stream');
      eventSource.onmessage = (e) => {
        if (e.data && !e.data.startsWith(':')) {
          const message = e.data;
          if (message.includes('Crawl process initiated')) {
            addLog('Crawl started');
          } else if (message.includes('Crawling:')) {
            addLog(message);
          } else if (message.includes('Completed:')) {
            pagesCrawled++;
            addLog(message, 'success');
            if (currentQueue > 0) {
              const percent = (pagesCrawled / (pagesCrawled + currentQueue)) * 100;
              progressBar.style.width = `${Math.min(percent, 100)}%`;
              progressText.textContent = `${Math.round(percent)}% - ${pagesCrawled} pages crawled`;
            } else {
              progressBar.style.width = '0%';
              progressText.textContent = '0% - waiting for queue load';
            }
          } else if (message.includes('Reached max') || message.includes('Token limit')) {
            addLog(message, 'error');
          } else if (message.includes('Crawl completed')) {
            addLog('Crawl finished', 'success');
            progressBar.style.width = '100%';
            progressText.textContent = `100% - ${pagesCrawled} pages crawled`;
            cancelBtn.classList.add('d-none');
            downloadBtn.classList.remove('d-none');
            eventSource.close();
          } else if (message.includes('Cancellation requested')) {
            addLog(`Cancelled after ${pagesCrawled} pages`, 'error');
            cancelBtn.classList.add('d-none');
            downloadBtn.classList.remove('d-none');
            eventSource.close();
          } else if (message.includes('Server is busy')) {
            addLog('Server busy, try later', 'error');
            eventSource.close();
          }
        }
      };

      try {
        const response = await fetch('/start-crawl', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });
        const data = await response.json();
        if (data.error) addLog(data.error, 'error');
      } catch (error) {
        addLog(`Error: ${error.message}`, 'error');
      } finally {
        crawlBtn.disabled = false;
        btnText.textContent = 'Start Crawl';
        btnSpinner.style.display = 'none';
      }
    });

    // Cancel button
    cancelBtn.addEventListener('click', async () => {
      try {
        const response = await fetch('/cancel', { method: 'POST' });
        const data = await response.json();
        addLog(data.message || 'Crawl cancelled', 'info');
      } catch (error) {
        addLog(`Cancel error: ${error.message}`, 'error');
      }
    });

    // Download button
    downloadBtn.addEventListener('click', (e) => {
      if (btnSpinner.style.display !== 'none') {
        e.preventDefault();
        downloadWait.classList.remove('d-none');
        setTimeout(() => downloadWait.classList.add('d-none'), 2000);
      } else {
        downloadWait.classList.remove('d-none');
        setTimeout(() => downloadWait.classList.add('d-none'), 1000);
      }
    });
  </script>
</body>
</html>
