<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Web Crawler - Dark Mode</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            bgDark: '#121212',
            card: '#1f1f1f',
            input: '#2b2b2b',
            accent: '#60a5fa',
            error: '#f87171',
            success: '#4ade80',
            info: '#a5b4fc'
          }
        }
      }
    }
  </script>
  <!-- Feather Icons CDN -->
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <!-- Google Font: Inter -->
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
  <style>
    /* Custom scrollbar for the log area */
    #log::-webkit-scrollbar {
      width: 8px;
    }
    #log::-webkit-scrollbar-track {
      background: #1f1f1f;
      border-radius: 8px;
    }
    #log::-webkit-scrollbar-thumb {
      background: #2b2b2b;
      border-radius: 8px;
    }
    #log::-webkit-scrollbar-thumb:hover {
      background: #3a3a3a;
    }
    /* Container thông báo đẩy hiển thị tại vị trí cũ (trong header của log process) */
    #log-notifications {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    /* Animation keyframes */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-10px); }
    }
    .fade-in {
      animation: fadeIn 0.5s ease-out forwards;
    }
    .fade-out {
      animation: fadeOut 0.5s ease-in forwards;
    }
  </style>
</head>
<body class="bg-bgDark text-gray-300 font-inter">
  <!-- Header -->
  <header class="bg-card shadow-sm">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center space-x-2">
        <i data-feather="search" class="w-6 h-6 text-accent"></i>
        <span class="text-xl font-semibold">Web Crawler</span>
      </div>
      <span class="text-sm text-gray-400">Crawl Documentation Data</span>
    </div>
  </header>

  <!-- Main Container -->
  <main class="max-w-5xl mx-auto px-4 py-10">
    <!-- Server Status -->
    <div id="server-status" class="mb-6 p-4 bg-card rounded-lg shadow text-sm flex flex-wrap items-center gap-4">
      <span class="font-medium">Server Status:</span>
      <span id="cpu-status" class="flex items-center">
        <i data-feather="cpu" class="w-4 h-4 mr-1"></i> CPU: --%
      </span>
      <span id="ram-status" class="flex items-center">
        <i data-feather="database" class="w-4 h-4 mr-1"></i> RAM: --%
      </span>
      <span id="temp-status" class="flex items-center">
        <i data-feather="thermometer" class="w-4 h-4 mr-1"></i> Temp: --°C
      </span>
      <span id="busy-status" class="flex items-center">
        <i data-feather="activity" class="w-4 h-4 mr-1"></i> Status: --
      </span>
    </div>

    <div class="bg-card rounded-xl shadow p-6 md:p-8">
      <h2 class="text-2xl font-semibold mb-6 text-center">Documentation Data Crawler</h2>
      
      <!-- Notification Message (nếu cần hiển thị thông báo khác ngoài push notification) -->
      <div id="notification" class="mb-4 hidden p-3 rounded-md text-sm"></div>
      
      <!-- Crawl Form -->
      <form id="crawl-form" class="space-y-5">
        <!-- URL Documentation -->
        <div>
          <label for="url" class="block mb-1 text-gray-400">Documentation URL</label>
          <input 
            type="url" 
            id="url" 
            class="w-full px-4 py-2 bg-input border border-gray-600 rounded-md focus:ring focus:ring-accent placeholder-gray-500 text-gray-200" 
            placeholder="https://supabase.com/docs" 
            required>
          <p class="text-xs text-gray-500 mt-1">Only crawl subpages under the root URL (e.g., https://supabase.com/docs/…)</p>
        </div>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
          <!-- Max Tokens -->
          <div>
            <label for="max_tokens" class="block mb-1 text-gray-400">Max Tokens</label>
            <input 
              type="number" 
              id="max_tokens" 
              class="w-full px-4 py-2 bg-input border border-gray-600 rounded-md focus:ring focus:ring-accent placeholder-gray-500 text-gray-200" 
              value="2000000" 
              placeholder="2000000">
            <p class="text-xs text-gray-500 mt-1">Limit tokens per page content</p>
          </div>
          <!-- Max Depth -->
          <div>
            <label for="max_depth" class="block mb-1 text-gray-400">Max Depth</label>
            <input 
              type="number" 
              id="max_depth" 
              class="w-full px-4 py-2 bg-input border border-gray-600 rounded-md focus:ring focus:ring-accent placeholder-gray-500 text-gray-200" 
              value="2" 
              placeholder="2">
            <p class="text-xs text-gray-500 mt-1">Crawl depth (default: 2)</p>
          </div>
          <!-- Concurrency -->
          <div>
            <label for="concurrency" class="block mb-1 text-gray-400">Concurrency</label>
            <input 
              type="number" 
              id="concurrency" 
              class="w-full px-4 py-2 bg-input border border-gray-600 rounded-md focus:ring focus:ring-accent placeholder-gray-500 text-gray-200" 
              value="3" 
              placeholder="3">
            <p class="text-xs text-gray-500 mt-1">Number of simultaneous requests</p>
          </div>
          <!-- Timeout -->
          <div>
            <label for="timeout" class="block mb-1 text-gray-400">Timeout (seconds)</label>
            <input 
              type="number" 
              id="timeout" 
              class="w-full px-4 py-2 bg-input border border-gray-600 rounded-md focus:ring focus:ring-accent placeholder-gray-500 text-gray-200" 
              value="10" 
              placeholder="10">
            <p class="text-xs text-gray-500 mt-1">Timeout for each request</p>
          </div>
          <!-- Max Pages -->
          <div class="sm:col-span-2">
            <label for="max_pages" class="block mb-1 text-gray-400">Max Pages</label>
            <input 
              type="number" 
              id="max_pages" 
              class="w-full px-4 py-2 bg-input border border-gray-600 rounded-md focus:ring focus:ring-accent placeholder-gray-500 text-gray-200" 
              value="100" 
              placeholder="100">
            <p class="text-xs text-gray-500 mt-1">Maximum number of pages to crawl</p>
          </div>
        </div>
        
        <!-- Start and Cancel Buttons -->
        <div class="flex flex-col sm:flex-row items-center justify-between gap-3">
          <button 
            type="submit" 
            id="crawl-btn" 
            class="w-full sm:w-auto flex items-center justify-center bg-accent hover:bg-blue-500 text-white font-medium px-6 py-2 rounded-md transition-colors disabled:opacity-70">
            <span id="btn-text">Start Crawl</span>
            <i data-feather="loader" id="btn-spinner" class="w-5 h-5 ml-2 animate-spin hidden"></i>
          </button>
          <button 
            type="button" 
            id="cancel-btn" 
            class="w-full sm:w-auto flex items-center justify-center bg-gray-600 hover:bg-gray-500 text-white font-medium px-6 py-2 rounded-md transition-colors hidden">
            <i data-feather="x-circle" class="w-5 h-5 mr-2"></i>
            <span>Cancel Crawl</span>
          </button>
        </div>
      </form>
      
      <!-- Log & Progress -->
      <div class="mt-8 space-y-5">
        <div>
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-lg font-semibold">Log Process</h3>
            <!-- Container thông báo đẩy tại vị trí cũ -->
            <div id="log-notifications"></div>
          </div>
          <div id="log" class="p-4 bg-input rounded-md border border-gray-600 font-mono text-sm h-48 overflow-y-auto"></div>
        </div>
        <div>
          <div class="w-full bg-gray-700 rounded-full h-2.5">
            <div id="progress-bar" class="bg-accent h-2.5 rounded-full" style="width: 100%;"></div>
          </div>
          <p id="progress-text" class="text-sm text-gray-400 mt-2">Progress: 0 pages crawled</p>
        </div>
      </div>
      
      <!-- Download JSON Button (visible after crawl completion) -->
      <div class="mt-8 text-center">
        <a 
          id="download" 
          href="/download" 
          class="inline-flex items-center bg-green-600 hover:bg-green-500 text-white font-medium px-6 py-2 rounded-md transition-colors hidden">
          <i data-feather="download-cloud" class="w-5 h-5 mr-2"></i>
          Download JSON
        </a>
      </div>
    </div>
  </main>
  
  <!-- Scripts for UI updates and server status -->
  <script>
    // Initialize Feather icons
    feather.replace();

    // Get DOM elements
    const form = document.getElementById("crawl-form");
    const notification = document.getElementById("notification");
    const logEl = document.getElementById("log");
    const crawlBtn = document.getElementById("crawl-btn");
    const btnText = document.getElementById("btn-text");
    const btnSpinner = document.getElementById("btn-spinner");
    const downloadBtn = document.getElementById("download");
    const cancelBtn = document.getElementById("cancel-btn");
    const progressText = document.getElementById("progress-text");
    const cpuStatus = document.getElementById("cpu-status");
    const ramStatus = document.getElementById("ram-status");
    const tempStatus = document.getElementById("temp-status");
    const busyStatus = document.getElementById("busy-status");

    let eventSource;
    let pagesCrawled = 0;

    // Hàm thêm thông báo đẩy với animation xuất hiện và biến mất, hiển thị tại vị trí cũ
    function addNotification(message, type = "info") {
      const container = document.getElementById("log-notifications");
      const notif = document.createElement("div");

      // Xác định màu sắc theo loại thông báo
      let bgColor, textColor;
      switch (type) {
        case "error":
          bgColor = "bg-error";
          textColor = "text-gray-50";
          break;
        case "success":
          bgColor = "bg-success";
          textColor = "text-gray-900";
          break;
        case "info":
        default:
          bgColor = "bg-info";
          textColor = "text-gray-900";
          break;
      }

      // Thiết lập class và nội dung cho thông báo, thêm hiệu ứng fade-in
      notif.className = `px-3 py-1 text-xs font-medium rounded-md ${bgColor} ${textColor} shadow-md fade-in`;
      notif.textContent = message;

      // Thêm thông báo mới vào container
      container.appendChild(notif);

      // Nếu vượt quá 3 thông báo, xóa thông báo đầu tiên (cũ nhất)
      if (container.children.length > 3) {
        container.removeChild(container.firstChild);
      }

      // Sau 5 giây, thêm class fade-out rồi xóa sau khi animation kết thúc (0.5s)
      setTimeout(() => {
        notif.classList.add("fade-out");
        setTimeout(() => {
          if (container.contains(notif)) {
            container.removeChild(notif);
          }
        }, 500);
      }, 5000);
    }

    // Cập nhật trạng thái server định kỳ
    async function updateServerStatus() {
      try {
        const res = await fetch('/status');
        if (!res.ok) throw new Error("Unable to fetch server status");
        const data = await res.json();
        cpuStatus.innerHTML = `<i data-feather="cpu" class="w-4 h-4 mr-1"></i> CPU: ${data.cpu}%`;
        ramStatus.innerHTML = `<i data-feather="database" class="w-4 h-4 mr-1"></i> RAM: ${data.ram}%`;
        tempStatus.innerHTML = `<i data-feather="thermometer" class="w-4 h-4 mr-1"></i> Temp: ${data.temperature}°C`;
        busyStatus.innerHTML = data.busy 
          ? `<i data-feather="activity" class="w-4 h-4 mr-1"></i> Status: Busy`
          : `<i data-feather="activity" class="w-4 h-4 mr-1"></i> Status: Idle`;
      } catch (error) {
        cpuStatus.innerHTML = `<i data-feather="cpu" class="w-4 h-4 mr-1"></i> CPU: --%`;
        ramStatus.innerHTML = `<i data-feather="database" class="w-4 h-4 mr-1"></i> RAM: --%`;
        tempStatus.innerHTML = `<i data-feather="thermometer" class="w-4 h-4 mr-1"></i> Temp: --°C`;
        busyStatus.innerHTML = `<i data-feather="activity" class="w-4 h-4 mr-1"></i> Status: --`;
      }
      feather.replace();
      setTimeout(updateServerStatus, 5000);
    }
    updateServerStatus();

    // Xử lý form submit để bắt đầu crawl
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      notification.classList.add("hidden");
      notification.textContent = "";
      crawlBtn.disabled = true;
      btnText.textContent = "Processing...";
      btnSpinner.classList.remove("hidden");
      cancelBtn.classList.remove("hidden");
      downloadBtn.classList.add("hidden");
      progressText.textContent = "Progress: 0 pages crawled";
      pagesCrawled = 0;
      logEl.innerHTML = "";

      const url = document.getElementById("url").value;
      const max_tokens = document.getElementById("max_tokens").value;
      const max_depth = document.getElementById("max_depth").value;
      const concurrency = document.getElementById("concurrency").value;
      const timeout = document.getElementById("timeout").value;
      const max_pages = document.getElementById("max_pages").value;

      if (!url) {
        addNotification("Please enter a valid URL!", "error");
        resetButton();
        return;
      }

      eventSource = new EventSource("/stream");
      eventSource.onmessage = (e) => {
        if (e.data && !e.data.startsWith(":")) {
          const message = e.data;
          
          // Ghi log cho quá trình crawl (nếu cần hiển thị log bên dưới)
          const logEntry = document.createElement("div");
          logEntry.className = "flex items-center text-gray-300 mb-1";
          logEntry.innerHTML = `<i data-feather="chevron-right" class="w-4 h-4 mr-1"></i> ${message}`;
          logEl.appendChild(logEntry);
          feather.replace();
          logEl.scrollTop = logEl.scrollHeight;

          // Dựa theo nội dung message, hiển thị thông báo đẩy tại vị trí cũ với animation
          if (message.includes("Crawl process initiated.")) {
            addNotification("Crawl initiated", "info");
          } else if (message.includes("Crawling:")) {
            addNotification("Processing...", "info");
          } else if (message.includes("Completed:")) {
            pagesCrawled++;
            progressText.textContent = `Progress: ${pagesCrawled} pages crawled`;
            addNotification("Page completed", "success");
          } else if (message.includes("Reached max pages limit") || message.includes("Token limit reached")) {
            addNotification("Limit reached", "error");
          } else if (message.includes("Crawl completed.")) {
            addNotification("Crawl completed", "success");
            progressText.textContent = `Progress: ${pagesCrawled} pages crawled (Completed)`;
            cancelBtn.classList.add("hidden");
            downloadBtn.classList.remove("hidden");
            eventSource.close();
          } else if (message.includes("Cancellation requested")) {
            addNotification(`Crawl cancelled after ${pagesCrawled} pages crawled. Data is available.`, "error");
            cancelBtn.classList.add("hidden");
            downloadBtn.classList.remove("hidden");
            eventSource.close();
          } else if (message.includes("Server is busy")) {
            addNotification("Server is busy. Please try again later.", "error");
            eventSource.close();
          }
        }
      };

      try {
        const response = await fetch("/start-crawl", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url, max_tokens, max_depth, concurrency, timeout, max_pages })
        });
        const data = await response.json();
        if (data.error) {
          addNotification(data.error, "error");
        }
      } catch (error) {
        addNotification(error.toString(), "error");
      } finally {
        resetButton();
      }
    });

    // Sự kiện cho nút Cancel
    cancelBtn.addEventListener("click", async () => {
      try {
        const response = await fetch("/cancel", { method: "POST" });
        const data = await response.json();
        addNotification(data.message || "Crawl cancelled successfully.", "info");
        cancelBtn.classList.add("hidden");
      } catch (error) {
        addNotification(error.toString(), "error");
      }
    });

    // Hàm hiển thị thông báo tạm thời (nếu cần)
    function showNotification(message, type = "error") {
      notification.textContent = message;
      if (type === "error") {
        notification.className = "p-3 rounded-md text-sm bg-error text-gray-50";
      } else if (type === "info") {
        notification.className = "p-3 rounded-md text-sm bg-info text-gray-900";
      } else {
        notification.className = "p-3 rounded-md text-sm bg-success text-gray-900";
      }
      notification.classList.remove("hidden");
    }

    // Hàm reset trạng thái nút khi kết thúc xử lý
    function resetButton() {
      crawlBtn.disabled = false;
      btnText.textContent = "Start Crawl";
      btnSpinner.classList.add("hidden");
    }
  </script>
</body>
</html>
